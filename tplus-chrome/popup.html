<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-size: 14px;
            font-family: Arial
        }

        #show_more_options {
            float: right;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
    <script type="text/javascript">
        var DEFAULT_HOLIDAY_CODE = 'TW_TOFF LEAVE PUBLIC_HOLIDAY',
                DEFAULT_ANNUAL_LEAVE_CODE = 'TW_TOFF LEAVE ANNUAL_LV',
                DEFAULT_SICK_LEAVE_CODE = 'TW_TOFF SICK SICK_LV';
    </script>
</head>
<body>
<h4>Hi, <span id="full_name"></span></h4>

<p>
    What are your initials used in SCM log entries?
    <input type="text" id="initials" value=""/>
</p>

<p>
    When is the ending date of the time report?
    <input type="text" id="end_date" value="" readonly="readonly"/>
    <button onclick="prev()">Prev</button>
    <button onclick="next()">Next</button>
    <a id="show_more_options" href="javascript:;" onclick="showMoreOptions()">+More</a>
</p>
<p id="more_options" style="display: none;">
    Where is your repository to retrieve log entries?
    <input type="text" id="repository_url" value=""/>
</p>
<button onclick="searchAndFill()">Generate Report</button>
<button onclick="addTimeRecord(DEFAULT_SICK_LEAVE_CODE)">+1 Sick Leave</button>
<button onclick="addTimeRecord(DEFAULT_ANNUAL_LEAVE_CODE)">+1 Annual Leave</button>
<button onclick="addTimeRecord(DEFAULT_HOLIDAY_CODE)">+1 Holiday</button>
<script type="text/javascript">
    var fullNameField = document.getElementById('full_name'),
            initialsField = document.getElementById('initials'),
            endDateField = document.getElementById('end_date'),
            repositoryUrlField = document.getElementById('repository_url'),
            queryOption = getQueryOption(),
            initialsMap = JSON.parse(localStorage['tplus_initials_map'] || '{}'),
            MILLI_SECONDS_IN_ONE_DAY = 1000 * 3600 * 24,
            today = new Date(),
            dayOfWeek = today.getDay() == 0 ? 7 : today.getDay(),
            endDate = dayOfWeek == 1
                    ? new Date(today.getTime() - MILLI_SECONDS_IN_ONE_DAY)
                    : new Date(today.getTime() + (7 - dayOfWeek) * MILLI_SECONDS_IN_ONE_DAY);

    fullNameField.innerText = queryOption.fullName;
    initialsField.value = initialsMap[queryOption.fullName] || '';
    endDateField.value = endDate.toDateString();
    repositoryUrlField.value = localStorage['tplus_repository_url'] || '';

    function getQueryOption() {
        return chrome.extension.getBackgroundPage()['queryOption'];
    }

    function getTabId() {
        return chrome.extension.getBackgroundPage()['tab'];
    }

    function prev() {
        endDate = new Date(endDate.getTime() - 7 * MILLI_SECONDS_IN_ONE_DAY);
        endDateField.value = endDate.toDateString();
    }

    function next() {
        endDate = new Date(endDate.getTime() + 7 * MILLI_SECONDS_IN_ONE_DAY);
        endDateField.value = endDate.toDateString();
    }

    function searchAndFill() {
        if (!initialsField.value) {
            initialsField.focus();
            return;
        }
        initialsMap[fullNameField.innerText] = initialsField.value;
        localStorage['tplus_initials_map'] = JSON.stringify(initialsMap);
        localStorage['tplus_repository_url'] = repositoryUrlField.value;
        chrome.tabs.sendRequest(getTabId(), {
            "action":"fillWorkRecords",
            "params":{
                "initials":initialsField.value,
                "endDate":endDateField.value,
                "repositoryUrl":repositoryUrlField.value
            }
        });
    }

    function addTimeRecord(code) {
        chrome.tabs.sendRequest(getTabId(), {
            "action":"addTimeRecord",
            "params":{"code":code}
        });
    }

    function addSickLeave() {
        chrome.tabs.sendRequest(getTabId(), {
            "action":"addSickLeaveRecord",
            "params":{}
        });
    }

    function showMoreOptions() {
        document.getElementById('show_more_options').style.display = 'none';
        document.getElementById('more_options').style.display = 'block';
    }
</script>
</body>
</html>