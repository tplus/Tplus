<!DOCTYPE html>
<html>
<head>
    <style>
        body {font-size: 14px;font-family: Arial;}
    </style>
</head>
<body>
<h4>Hi, <span id="full_name"></span></h4>
<p>
    please provide your id, name or initials used in the SCM log entries:
    <input type="text" id="initials" value=""/>
</p>
<p>
    and specify the week ending date of the time report you wish to fill:
    <input type="text" id="end_date" value="" readonly="readonly"/>
    <button onclick="prev()">Prev</button><button onclick="next()">Next</button>
</p>
<button onclick="searchAndFill()">Generate Report</button>
<script type="text/javascript">
    var fullNameField = document.getElementById('full_name'),
            initialsField = document.getElementById('initials'),
            endDateField = document.getElementById('end_date'),
            queryOption = getQueryOption(),
            initialsMap = JSON.parse(localStorage['tplus_initials_map'] || '{}'),
            MILLI_SECONDS_IN_ONE_DAY = 1000 * 3600 * 24,
            today = new Date(),
            dayOfWeek = today.getDay() == 0 ? 7 : today.getDay(),
            endDate = dayOfWeek == 1
                    ? new Date(today.getTime() - MILLI_SECONDS_IN_ONE_DAY)
                    : new Date(today.getTime() + (7 - dayOfWeek) * MILLI_SECONDS_IN_ONE_DAY);

    fullNameField.innerText = queryOption.fullName;
    initialsField.value = initialsMap[queryOption.fullName] || '';
    endDateField.value = endDate.toDateString();

    function getQueryOption() {
        return chrome.extension.getBackgroundPage()['queryOption'];
    }

    function getTabId() {
        return chrome.extension.getBackgroundPage()['tab'];
    }

    function prev() {
        endDate =  new Date(endDate.getTime() - 7 * MILLI_SECONDS_IN_ONE_DAY);
        endDateField.value = endDate.toDateString();
    }

    function next() {
        endDate =  new Date(endDate.getTime() + 7 * MILLI_SECONDS_IN_ONE_DAY);
        endDateField.value = endDate.toDateString();
    }

    function searchAndFill() {
        if(!initialsField.value) {
            initialsField.focus();
            return;
        }
        initialsMap[fullNameField.innerText] = initialsField.value;
        localStorage['tplus_initials_map'] = JSON.stringify(initialsMap);
        chrome.tabs.sendRequest(getTabId(), {"initials":initialsField.value, "endDate":endDateField.value});
    }
</script>
</body>
</html>